pipeline {
    agent any

    environment {
        AWS_REGION = 'ap-south-1' 
        INSTANCE_NAME = 'Terraform-Instance'
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
       
    }

     stages {
        stage('Choose EC2 Action') {
            steps {
                script {
                    def userChoice = input(
                        id: 'userChoice', 
                        message: 'Choose an action for EC2 instance:',
                        parameters: [choice(choices: 'Stop\nStart\nTerminate', description: 'Select an action', name: 'Action')]
                    )

                    // Execute the selected stage based on user choice
                    switch (userChoice) {
                        case 'Stop':
                            echo "Stopping EC2 Instance"
                            stopEC2Instance()
                            break
                        case 'Start':
                            echo "Starting EC2 Instance"
                            startEC2Instance()
                            break
                        case 'Terminate':
                            echo "Terminating EC2 Instance"
                            terminateEC2Instance()
                            break
                        default:
                            echo "Invalid choice: ${userChoice}"
                            currentBuild.result = 'FAILURE'
                    }
                }
            }
        }
    }

    def stopEC2Instance() {
        script {
            def instanceId = getInstanceId()
            echo "Instance ID: ${instanceId}"

            sh "aws ec2 stop-instances --region ${AWS_REGION} --instance-ids ${instanceId}"
            sh "aws ec2 wait instance-stopped --region ${AWS_REGION} --instance-ids ${instanceId}"
        }
    }

    def terminateEC2Instance() {
        script {
            def instanceId = getInstanceId()
            echo "Instance ID: ${instanceId}"

            sh "aws ec2 terminate-instances --region ${AWS_REGION} --instance-ids ${instanceId}"
            sh "aws ec2 wait instance-terminated --region ${AWS_REGION} --instance-ids ${instanceId}"
        }
    }

    def startEC2Instance() {
        script {
            def instanceId = getInstanceId()
            echo "Instance ID: ${instanceId}"

            sh "aws ec2 start-instances --region ${AWS_REGION} --instance-ids ${instanceId}"
            sh "aws ec2 wait instance-running --region ${AWS_REGION} --instance-ids ${instanceId}"
        }
    }

    def getInstanceId() {
        script {
            return sh "aws ec2 describe-instances --region ${AWS_REGION} --filters Name=tag:Name,Values=${INSTANCE_NAME} --query 'Reservations[0].Instances[0].InstanceId' --output text".trim()
        }
    }
}
